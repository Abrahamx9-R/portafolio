---
import Layout from '../../../layouts/Layout.astro';
import SectionContainer from '../../../components/SectionContainer.astro';
import BlogSidebar from '../../../components/BlogSidebar.astro';
import { getCollection } from 'astro:content';
import { t } from '../../../i18n/translations';
import { getLocalizedPath } from '../../../i18n/utils';

const lang = 'en';

const allPosts = (await getCollection('blog'))
    .filter(post => post.data.lang === lang)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout lang={lang}>
    <div class="pt-24 pb-20">
        <div class="container mx-auto px-4">
            
            <SectionContainer class="!py-0 mb-12">
                 <h1 class="text-5xl md:text-7xl font-heading font-bold text-white mb-2">
                    <span class="text-neon-cyan">///</span> {t(lang, 'blog.title')}
                </h1>
                <p id="filter-status" class="text-xl text-gray-400 max-w-2xl">
                    Documenting the journey through the digital frontier.
                </p>
            </SectionContainer>

            <div class="flex flex-col md:flex-row gap-12">
                <!-- Sidebar -->
                <BlogSidebar lang={lang} />

                <!-- Main Content -->
                <div class="flex-1 min-w-0">
                    <div id="posts-grid" class="grid grid-cols-1 gap-8">
                        {allPosts.map((post) => (
                            <a 
                                href={getLocalizedPath(`/blog/${post.slug.split('/').pop()}`, lang)} 
                                class="blog-card flex flex-col md:flex-row gap-6 p-6 border border-white/10 bg-space-800/30 hover:border-neon-cyan/50 hover:bg-space-800/50 transition-all group"
                                data-category={post.data.category}
                                data-title={post.data.title.toLowerCase()}
                                data-desc={post.data.description.toLowerCase()}
                            >
                                <!-- Image / Graphic -->
                                <div class="w-full md:w-1/3 aspect-video bg-space-900 relative overflow-hidden flex items-center justify-center border border-white/5">
                                    {post.data.heroImage ? (
                                        <img src={post.data.heroImage} alt="" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity" />
                                    ) : (
                                        <span class="font-mono text-gray-600">[NO_IMAGE]</span>
                                    )}
                                    <div class="absolute inset-0 bg-neon-cyan mix-blend-overlay opacity-0 group-hover:opacity-20 transition-opacity"></div>
                                </div>

                                <div class="flex-1 flex flex-col justify-center">
                                    <div class="flex items-center gap-4 mb-2">
                                        <span class="font-mono text-neon-cyan text-sm">{post.data.pubDate.toLocaleDateString()}</span>
                                        <div class="h-[1px] flex-1 bg-white/10"></div>
                                        <span class="text-xs font-mono px-2 py-0.5 border border-lcars-tertiary text-lcars-tertiary rounded uppercase">{post.data.category}</span>
                                    </div>
                                    
                                    <h2 class="text-2xl md:text-3xl font-heading font-bold text-white mb-3 group-hover:text-neon-cyan transition-colors">
                                        {post.data.title}
                                    </h2>
                                    
                                    <p class="text-gray-400 font-body mb-4 line-clamp-2">
                                        {post.data.description}
                                    </p>
                                    
                                    <div class="mt-auto flex gap-2">
                                        {post.data.tags?.map(tag => (
                                            <span class="text-xs font-mono px-2 py-1 bg-white/5 text-gray-300 border border-white/10">
                                                #{tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>

                    <!-- No Results Message -->
                    <div id="no-results" class="hidden p-12 border border-white/10 bg-space-800/20 text-center">
                        <p class="text-gray-400 font-mono">{t(lang, 'blog.noResults')}</p>
                        <button id="clear-filters" class="inline-block mt-4 text-neon-cyan hover:underline uppercase">{t(lang, 'blog.filter.clear')}</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</Layout>

<script define:vars={{ 
    filterStatusLabel: t(lang, 'blog.filter.status'), 
    allTypesLabel: t(lang, 'blog.filter.all'),
    defaultDesc: 'Documenting the journey through the digital frontier.' 
}}>
    // Client-side filtering logic
    document.addEventListener('astro:page-load', () => {
        initBlogFilters();
    });

    // Run on initial load too if view transitions aren't active or for first visit
    initBlogFilters();

    function initBlogFilters() {
        const searchInput = document.getElementById('blog-search');
        const categoryBtns = document.querySelectorAll('.category-btn');
        const posts = document.querySelectorAll('.blog-card');
        const noResults = document.getElementById('no-results');
        const statusText = document.getElementById('filter-status');
        const clearBtn = document.getElementById('clear-filters');
        
        if (!searchInput || !posts.length) return;

        let activeCategory = allTypesLabel; 
        let currentCategory = allTypesLabel; 
        let searchQuery = '';

        const allBtn = Array.from(categoryBtns).find(btn => btn.dataset.category === allTypesLabel);
        if(allBtn) allBtn.classList.add('active');

        function filterPosts() {
            let visibleCount = 0;

            posts.forEach(post => {
                const postCategory = post.dataset.category;
                const postTitle = post.dataset.title;
                const postDesc = post.dataset.desc;
                
                const matchesCategory = currentCategory === allTypesLabel || postCategory === currentCategory;
                const matchesSearch = postTitle?.includes(searchQuery) || postDesc?.includes(searchQuery);

                if (matchesCategory && matchesSearch) {
                    post.style.display = 'flex';
                    visibleCount++;
                } else {
                    post.style.display = 'none';
                }
            });

            // Toggle No Results
            if (visibleCount === 0) {
                noResults?.classList.remove('hidden');
            } else {
                noResults?.classList.add('hidden');
            }
            
            // Update Status Text
            if (currentCategory !== allTypesLabel || searchQuery) {
                statusText.textContent = `${filterStatusLabel} ${currentCategory} ${searchQuery ? `+ "${searchQuery}"` : ''}`;
            } else {
                statusText.textContent = defaultDesc;
            }

            // Update Active Button State
            categoryBtns.forEach(btn => {
                if (btn.dataset.category === currentCategory) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Event Listeners
        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            filterPosts();
        });

        categoryBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentCategory = btn.dataset.category || allTypesLabel;
                filterPosts();
            });
        });

        clearBtn?.addEventListener('click', () => {
            currentCategory = allTypesLabel;
            searchQuery = '';
            searchInput.value = '';
            filterPosts();
        });
    }
</script>
